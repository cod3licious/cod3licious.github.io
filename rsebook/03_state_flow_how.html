<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; State &amp; Flow: How? ‚Äì Clarity-Driven Development of Scientific Software</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./part2.html" rel="next">
<link href="./02_output_what.html" rel="prev">
<link href="./favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-f3084fe83d417c7d07102af91575287a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="style.css">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part1.html">Part 1: Gaining Clarity</a></li><li class="breadcrumb-item"><a href="./03_state_flow_how.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">State &amp; Flow: How?</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Clarity-Driven Development of Scientific Software</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_tools.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Set Up to Deliver</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 1: Gaining Clarity</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_outcome_why.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Outcome: Why?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_output_what.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Output: What?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_state_flow_how.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">State &amp; Flow: How?</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./part2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Part 2: Writing Code</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_implementation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Implementation Essentials</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_from_research_to_production.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">From Research to Production</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./afterword.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Afterword</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#working-code" id="toc-working-code" class="nav-link active" data-scroll-target="#working-code">Working Code</a>
  <ul class="collapse">
  <li><a href="#impact-beyond-code" id="toc-impact-beyond-code" class="nav-link" data-scroll-target="#impact-beyond-code">Impact Beyond Code</a></li>
  <li><a href="#state-flow" id="toc-state-flow" class="nav-link" data-scroll-target="#state-flow">State &amp; Flow</a></li>
  </ul></li>
  <li><a href="#good-code" id="toc-good-code" class="nav-link" data-scroll-target="#good-code">Good Code</a>
  <ul class="collapse">
  <li><a href="#analogy-the-cupcake-recipe" id="toc-analogy-the-cupcake-recipe" class="nav-link" data-scroll-target="#analogy-the-cupcake-recipe">Analogy: The Cupcake Recipe</a></li>
  <li><a href="#encapsulated" id="toc-encapsulated" class="nav-link" data-scroll-target="#encapsulated">Encapsulated</a></li>
  <li><a href="#decoupled" id="toc-decoupled" class="nav-link" data-scroll-target="#decoupled">Decoupled</a></li>
  <li><a href="#reusable" id="toc-reusable" class="nav-link" data-scroll-target="#reusable">Reusable</a></li>
  <li><a href="#summary-from-working-to-good-code" id="toc-summary-from-working-to-good-code" class="nav-link" data-scroll-target="#summary-from-working-to-good-code">Summary: From Working to Good Code</a></li>
  </ul></li>
  <li><a href="#sec-draw-code" id="toc-sec-draw-code" class="nav-link" data-scroll-target="#sec-draw-code">Draw Your Code</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./part1.html">Part 1: Gaining Clarity</a></li><li class="breadcrumb-item"><a href="./03_state_flow_how.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">State &amp; Flow: How?</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-state-flow-how" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">State &amp; Flow: How?</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Now that you know what outputs (e.g., result plots) you want to create, are you itching to start programming? Hold on for a moment!</p>
<p>One of the most <strong>common missteps</strong> I‚Äôve seen junior developers take is <strong>jumping straight into coding without first thinking through what they actually want to write</strong>. Imagine trying to construct a house by just laying bricks without consulting an architect first‚Äîhalfway through you‚Äôd probably realize the walls don‚Äôt align, and you forgot the plumbing for the kitchen. You‚Äôd have to tear it down and start over! To avoid this fate for your software, it‚Äôs essential to make a plan and sketch out the final design first‚Äîto gain clarity on <strong>how you could best implement your solution</strong> (<a href="#fig-code-questions-3" class="quarto-xref">Figure&nbsp;<span>4.1</span></a>).</p>
<div id="fig-code-questions-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-code-questions-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/00_clarity/code_questions_3.png" class="img-fluid figure-img" style="width:63.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-code-questions-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: Before we write code, we should first think about what it is we actually want to write, i.e., how this code is supposed to work.
</figcaption>
</figure>
</div>
<p>Your software design doesn‚Äôt have to be perfect‚Äîwe don‚Äôt want to overengineer our solution, especially since many details only become clear once we start coding and see how users interact with the software. But the more thought you put into planning, the smoother and faster execution will be.</p>
<p>Unlike a house, where your design will be quite literally set in stone, code should be designed with flexibility in mind. While expanding a house to add extra rooms for a growing family‚Äîand then removing them again when downsizing for retirement‚Äîwould be costly and difficult, this kind of adaptability is exactly what we strive for in software. Our goal is to <strong>create code that can evolve with changing requirements</strong>.</p>
<p>To make sure your designs will be worthy of implementation, this chapter introduces key paradigms and best practices that will help you create <strong>clean, maintainable code that‚Äôs easy to extend and reuse</strong> in future projects.</p>
<section id="difference-between-commercial-software-and-research-code" class="level4">
<h4 class="anchored" data-anchor-id="difference-between-commercial-software-and-research-code">Difference Between Commercial Software and Research Code?</h4>
<p>Commercial software applications and the scripts used in your research share many of the same core principles‚Äîboth involve writing code to produce outputs, and both benefit from the same standards of good code quality. That‚Äôs the topic of this chapter.<br>
However, full-scale software applications, especially those with graphical interfaces, are naturally more complex than a script that generates static results. The additional components required for production-grade software are covered later in <a href="05_from_research_to_production.html" class="quarto-xref"><span>Chapter 6</span></a>.</p>
</section>
<section id="working-code" class="level2">
<h2 class="anchored" data-anchor-id="working-code">Working Code</h2>
<p>Before we talk about the best practices for creating <em>good code</em>, let‚Äôs first examine what our program is actually supposed to do and which steps we need to execute to produce our desired output‚Äîin other words, how to create <em>working code</em>.</p>
<section id="impact-beyond-code" class="level3">
<h3 class="anchored" data-anchor-id="impact-beyond-code">Impact Beyond Code</h3>
<p>A program would be useless if it did some computation but never revealed the results to anyone. In the end, we always want to produce some kind of <strong>effect on the world outside of our code</strong> by interacting with users, data stores, or other external systems (<a href="#fig-impact-beyond" class="quarto-xref">Figure&nbsp;<span>4.2</span></a>).</p>
<div id="fig-impact-beyond" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-impact-beyond-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/00_clarity/impact_beyond.png" class="img-fluid figure-img" style="width:65.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-impact-beyond-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.2: To be useful, our code needs to have an effect on the outside world. First and foremost, a program usually interacts with its users through a <strong>Graphical User Interface (GUI)</strong> or <strong>Command Line Interface (CLI)</strong> where outputs are presented to users and they may be prompted for inputs. Next, the program often reads and writes data from and to <strong>data stores</strong> like <strong>files</strong> or <strong>databases</strong>. These may contain inputs necessary for calculations or be used to persist (i.e., save) user inputs or the results from our calculations. Finally, our program may also interact with an external system, such as a web service, through an <strong>API (Application Programming Interface)</strong>, an interface designed specifically for two software components to communicate and exchange data. These external systems in turn might also have their own user interfaces and data stores, but these are of no concern for our program.
</figcaption>
</figure>
</div>
<p>The impact of our code can take many different forms:</p>
<ul>
<li>Writing a log message with the result from a calculation to the console.</li>
<li>Displaying information in a graphical user interface (GUI) and asking the user for input.</li>
<li>Writing outputs to a file (e.g., an Excel spreadsheet or a PNG image).</li>
<li>Creating, updating, or deleting records in a database.</li>
<li>Querying an external web API (e.g., through a POST request).</li>
<li>Sending an email.</li>
<li>Transmitting the necessary signals to move the actuators in a robotic arm.</li>
</ul>
<p>In the previous chapter, we‚Äôve talked at length about what outputs we should show our users to create an optimal user experience. In <a href="05_from_research_to_production.html" class="quarto-xref"><span>Chapter 6</span></a>, we‚Äôll cover how our program can interact with external systems through (web) APIs. So let‚Äôs now turn to the topic of data persistence.</p>
<section id="data-persistence" class="level4">
<h4 class="anchored" data-anchor-id="data-persistence">Data Persistence</h4>
<p>As our code runs, all the data it generates through its calculations and transformations is only present in the computer‚Äôs working memory (RAM). Once the program terminates‚Äîwhether because it is finished with its task or crashes due to an error‚Äîthese in-memory values are gone. It can therefore be helpful to <strong>persist (i.e., save) intermediate results</strong> while our code is executed.</p>
<p>Often, <strong>intermediate results are also created and consumed by different scripts or processes</strong>, for example:</p>
<ul>
<li>You run simulations that output data to CSV files. These files are then used by a separate script to generate plots.</li>
<li>You define model settings in a <code>config.json</code> file, which your script reads to initialize the model with the correct configuration.</li>
<li>A user fills out a form on a website. Their information is stored in a database so it can later be retrieved and displayed on their profile page.</li>
</ul>
<p>In these cases especially, it‚Äôs important to <strong>carefully design the structure</strong> of this intermediate data‚Äîwhat fields it includes, what they‚Äôre called, and how they‚Äôre organized. Because if you later need to <strong>change the format</strong>, you‚Äôll have to <strong>update both the producer and consumer processes</strong>, and potentially <strong>migrate existing data</strong>.</p>
<p>To design an effective structure, start by identifying the fields required by the downstream process. Then consider whether other processes will use this data and if they might need additional fields. You might also want to store the data at a finer level of detail than what‚Äôs currently needed. It‚Äôs much easier to extract or summarize detailed data later than to reverse-engineer missing details from aggregate values. For example, if you first plan to plot only the final simulation outcome but later want to show values over time, you must have saved the variables at each time step.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Plan your experiments">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Plan your experiments
</div>
</div>
<div class="callout-body-container callout-body">
<p>If your code is supposed to do more than generate result plots‚Äîfor example, if you‚Äôre running a simulation‚Äîyou also need to <strong>plan your experiment runs</strong>.<br>
Think about the data each experiment run will generate and how you‚Äôll process it later. For instance, you might need a separate script that loads data from multiple runs to create additional plots comparing the performance of different models. This is simplified by using <strong>a clear naming convention</strong> for all output files, such as:</p>
<pre><code>{dataset}_{model}_{model_settings}_{seed}.csv</code></pre>
<p>To determine all possible configuration variants for your experiments, consider:</p>
<ul>
<li>The models or algorithms you want to compare (your approach and relevant baselines).</li>
<li>The hyperparameter settings you want to test for each model.</li>
<li>The datasets or simulation environments on which you‚Äôll evaluate your models.</li>
<li>If your setup includes randomness (e.g., model initialization or simulation stochasticity), how many different random seeds you‚Äôll use to estimate variability.</li>
</ul>
<p>Ideally, your code should allow you to <strong>run the same script with different parameter configurations</strong>, making it easy to test multiple setups.</p>
<p>If each experiment takes several hours or days, check whether you can run them on a compute cluster and submit each experiment as a separate job to <strong>run in parallel</strong>.</p>
</div>
</div>
</section>
</section>
<section id="state-flow" class="level3">
<h3 class="anchored" data-anchor-id="state-flow">State &amp; Flow</h3>
<p>Code, at its core, is about <strong>transforming inputs into outputs</strong> <span class="citation" data-cites="thomas2019pragmatic">[<a href="references.html#ref-thomas2019pragmatic" role="doc-biblioref">10</a>]</span>. For example, a script could contain the steps needed to turn the data read from a spreadsheet (input) into a result plot shown to the user (output).</p>
<p>To drive this transformation process, the code defines a sequence of operations (e.g., adding or multiplying values), conditional statements (e.g., <code>if/else</code>), and loops (e.g., <code>for</code> and <code>while</code>)‚Äîcollectively known as an algorithm or <strong>control flow</strong>.<br>
As these instructions are executed, both the inputs and the intermediate results are stored in variables, which represent the current <strong>state</strong> of the program.</p>
<section id="data-structures" class="level4">
<h4 class="anchored" data-anchor-id="data-structures">Data Structures</h4>
<p><strong>Variables</strong> (like <code>y</code>) store values (like <code>42</code>). When we initialize a variable, it points to a location in the computer‚Äôs memory‚Äîa sequence of bits (0s and 1s)‚Äîthat can be decoded into a specific value. To decode these bits correctly, the system must know the <strong>data type</strong> of the value being stored. For example, the binary <code>101010</code> represents <code>42</code> as an integer, but if interpreted as an ASCII character, it yields <code>"*"</code>. These data types range in complexity:</p>
<ul>
<li><strong>Primitive data types</strong>: Simple values like integers or strings (as discussed in <a href="02_output_what.html#sec-data" class="quarto-xref"><span>Section 3.2.1</span></a>).</li>
<li><strong>Composite data types</strong>: Structures like lists, sets, and dictionaries that hold multiple values.</li>
<li><strong>Nonlinear data types</strong>: Structures like trees and graphs, used to model complex relationships such as hierarchies or networks.</li>
<li><strong>User-defined objects</strong>: Custom structures defined in classes, tailored for specific use cases.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># primitive data type: float</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">4.1083</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># composite data type: list</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>my_list <span class="op">=</span> [<span class="st">"hello"</span>, <span class="dv">42</span>, x]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># composite data type: dict</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>my_dict <span class="op">=</span> {</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"key1"</span>: <span class="st">"hello"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"key2"</span>: <span class="dv">42</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"key3"</span>: my_list,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Depending on the problem you‚Äôre solving, <strong>choosing the right data structure</strong> can make a big difference. For example, structures like trees or graphs can simplify operations such as finding related values or navigating nested relationships. That‚Äôs why it‚Äôs important to consider not just the sequence of operations in our code, but also how the data is structured.</p>
<p>We can define custom data structures using <strong>classes</strong>. These are especially useful when multiple values represent a single entity. For instance, instead of managing separate variables like <code>first_name</code>, <code>last_name</code>, and <code>birthdate</code>, we can group them into a single <strong>object</strong> of a <code>Person</code> class.</p>
<p>While dictionaries could also store related fields, they offer less control: keys and values can be added or removed dynamically and without constraints. In contrast, classes provide structure and validation, such as enforcing required attributes during object creation or controlling how attributes are accessed or updated via class methods.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> date</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, first_name: <span class="bu">str</span>, last_name: <span class="bu">str</span>, birthdate: date):</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.first_name <span class="op">=</span> first_name</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.last_name <span class="op">=</span> last_name</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> birthdate <span class="op">&gt;</span> date.today():</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Date of birth cannot be in the future."</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># this attribute is private (by prefixing _)</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># to discourage access outside of the class</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._bdate <span class="op">=</span> birthdate</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_age(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">int</span>:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># code outside the class only gets access to the person's age</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        today <span class="op">=</span> date.today()</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        age <span class="op">=</span> today.year <span class="op">-</span> <span class="va">self</span>._bdate.year</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (today.month, today.day) <span class="op">&lt;</span> (<span class="va">self</span>._bdate.month, <span class="va">self</span>._bdate.day):</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            age <span class="op">-=</span> <span class="dv">1</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> age</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>   new_person <span class="op">=</span> Person(<span class="st">"Jane"</span>, <span class="st">"Doe"</span>, date(<span class="dv">1988</span>, <span class="dv">5</span>, <span class="dv">20</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="step-by-step-from-output-to-input" class="level4">
<h4 class="anchored" data-anchor-id="step-by-step-from-output-to-input">Step by Step: From Output to Input</h4>
<p>To determine the sequence of instructions for obtaining our desired outputs, we can <strong>work backward to figure out which inputs we need and how these should be transformed</strong> (<a href="#fig-work-backward" class="quarto-xref">Figure&nbsp;<span>4.3</span></a>).</p>
<div id="fig-work-backward" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-pos="H">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-work-backward-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/02_data/work_backward.png" class="img-fluid figure-img" style="width:75.0%" data-fig-pos="H">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-work-backward-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.3: Work backward from the desired results to determine what data is needed to create them.
</figcaption>
</figure>
</div>
<p>Let‚Äôs map out the steps required to create the above scatter plot displaying actual values <span class="math inline">\(y\)</span> (<code>y</code>), model predictions <span class="math inline">\(\hat{y}\)</span> (<code>y_pred</code>), and the <span class="math inline">\(R^2\)</span> value (<code>R2</code>) in the title to indicate the model‚Äôs goodness of fit:</p>
<ol type="1">
<li><p>To create the plot, we need <code>R2</code>, <code>y</code>, and <code>y_pred</code>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>plot_results(R2, y, y_pred)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><code>R2</code> can be computed from the values stored in <code>y</code> and <code>y_pred</code>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>R2 <span class="op">=</span> compute_r2(y, y_pred)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><code>y</code> can be loaded from a file containing test data.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> ...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p><code>y_pred</code> must be estimated using our model, which requires:</p>
<ul>
<li>The corresponding input values (<code>x1</code> ‚Ä¶ <code>x5</code>) from the test data file.</li>
<li>A trained model that can make predictions.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> ...</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_test)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p>To obtain a trained model, we need to:</p>
<ul>
<li>Create an instance of the model with the correct configuration.</li>
<li>Load the training data.</li>
<li>Train the model on the training data.</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MyModel(config)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>X_train, y_train <span class="op">=</span> ...</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>model.fit(X_train, y_train)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
<li><p>The model configuration needs to be provided by the user when running the script.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>config <span class="op">=</span> ...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div></li>
</ol>
<div id="fig-state-flow" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-state-flow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/00_clarity/state_flow.png" class="img-fluid figure-img" style="width:90.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-state-flow-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.4: Variables (state) created in intermediate steps as a script transforms inputs into our desired output. The purple dots symbolize the code statements (control flow) required for these transformations, possibly grouped into functions or class methods.
</figcaption>
</figure>
</div>
<p>The steps are summarized in <a href="#fig-state-flow" class="quarto-xref">Figure&nbsp;<span>4.4</span></a>. Of course, in the actual implementation, each step will require further details (e.g., the formula for computing <span class="math inline">\(R^2\)</span> or how to load the training and test datasets). But since we know that this sequence of transformations will produce the desired output, this already provides us with the rough outline of our code (see <a href="#sec-draw-code" class="quarto-xref"><span>Section 4.3</span></a> for how these steps could come together in the final script).</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Optimize the ordering of steps">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Optimize the ordering of steps
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Some steps depend on others</strong> (e.g., we must fit our model before making predictions), but others can be performed in any order. Optimizing their sequence can <strong>improve performance and efficiency</strong>.</p>
<p>For example, if you‚Äôre baking bread, you wouldn‚Äôt preheat the oven hours before the dough has risen‚Äîthat would waste energy. Similarly, if you‚Äôre processing a large dataset, where you need to perform an expensive computation on each item but only a specific subset of these items is included in the final results, then it may be more efficient to filter the items first so you only compute values for the necessary items:</p>
<div id="fig-step-order" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center" data-fig-pos="H">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-step-order-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/order_of_steps.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%" data-fig-pos="H">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-step-order-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.5: Improve efficiency through the order of steps.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="designing-an-algorithm" class="level4">
<h4 class="anchored" data-anchor-id="designing-an-algorithm">Designing an Algorithm</h4>
<p>Some problems require more <strong>creativity to come up with an efficient algorithm</strong> that produces the correct output from a given input. Take the <strong>traveling salesman problem</strong>, where the goal is to find the shortest possible route through a given set of cities. Designing an efficient solution often involves choosing the right <strong>data structures</strong> (e.g., representing cities as nodes in a graph), using <strong>heuristics</strong>, and <strong>breaking the problem down into simpler subproblems</strong> (divide &amp; conquer strategy). If you‚Äôre working on a novel problem, studying algorithm design can be invaluable (one of my favorite books on the topic is <em>The Algorithm Design Manual</em> by Steven Skiena <span class="citation" data-cites="skiena2008algorithm">[<a href="references.html#ref-skiena2008algorithm" role="doc-biblioref">9</a>]</span>).</p>
<p>However, for many common tasks, you can <strong>leverage existing algorithms</strong> instead of reinventing the wheel. For the rest of this book, we‚Äôll assume you already have a general idea of the steps your code needs to perform and focus on how to implement them effectively.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Practice algorithmic thinking">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Practice algorithmic thinking
</div>
</div>
<div class="callout-body-container callout-body">
<p>Coming up with efficient algorithms‚Äîeven for simple problems‚Äîoften takes practice. Platforms like <a href="https://leetcode.com/">LeetCode</a> provide a fun way to build that skill by working through small, focused problems.</p>
</div>
</div>
<p>While the sequence of steps we derived above enables us to create <em>working code</em>, unfortunately, this is not the same as <em>good code</em>. A <strong>script that consists of a long list of instructions</strong> can be difficult to read, understand, and maintain. Since you‚Äôll likely be working with the same code for a while‚Äîand may even want to reuse parts of it in future projects‚Äîit‚Äôs worth investing in a better design. Let‚Äôs explore how to make that happen.</p>
</section>
</section>
</section>
<section id="good-code" class="level2">
<h2 class="anchored" data-anchor-id="good-code">Good Code</h2>
<p>When we talk about ‚Äúgood code‚Äù in this book, we focus on three key properties, each building upon and influencing the others:</p>
<ol type="1">
<li><p><strong>Easy to understand:</strong> To work with code, you need to be able to understand it. When using a common library, it may be enough to know what a function does and how to use it, trusting that it works correctly under the hood. But with your own code, you also need to understand the implementation details. Otherwise, you‚Äôll hesitate to make changes and won‚Äôt be able to confidently say that your program behaves as expected. Since code is read far more often than it is written, making it easy to understand ultimately saves time in the long run.</p></li>
<li><p><strong>Easy to change:</strong> Code is never truly finished. It requires ongoing maintenance‚Äîfixing bugs, updating dependencies (e.g., when a library releases a security patch with breaking changes), and adapting to evolving requirements, such as adding new features to stay competitive. Code that is easy to modify makes all of this much smoother.</p></li>
<li><p><strong>Easy to build upon and reuse:</strong> Ideally, adding new features shouldn‚Äôt mean proportional growth in your codebase. Instead, you should be able to reuse existing functionality. Following the DRY (Don‚Äôt Repeat Yourself) principle‚Äîavoiding redundant logic‚Äîalso makes code easier to maintain because updates only need to be made in one place.</p></li>
</ol>
<p>These qualities (along with others, like being easy to test) can be achieved through <strong>encapsulation</strong>, i.e., breaking the code into smaller units, and ensuring that these units are <strong>decoupled</strong> and <strong>reusable</strong>. This approach has multiple benefits:</p>
<ul>
<li>Smaller units fit comfortably into your working memory, making them easier to understand and reason about, which lowers the overall cognitive load of your code.</li>
<li>Since units are independent, you can change one without unintended side effects elsewhere.</li>
<li>Well-designed, general-purpose units act as building blocks, allowing you to quickly assemble more complex functionality‚Äîlike constructing something out of LEGO bricks.</li>
</ul>
<section id="analogy-the-cupcake-recipe" class="level3">
<h3 class="anchored" data-anchor-id="analogy-the-cupcake-recipe">Analogy: The Cupcake Recipe</h3>
<p>Before diving into how to write good code, let‚Äôs explore some of the basic principles using a more relatable example: a cupcake recipe (<a href="#fig-recipe-code" class="quarto-xref">Figure&nbsp;<span>4.6</span></a>). Because who wants result plots when you could have cupcakes?! üßÅ</p>
<div id="fig-recipe-code" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-recipe-code-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/00_clarity/recipe_code.png" class="img-fluid figure-img" style="width:63.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-recipe-code-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.6: A chef writes a recipe, which then needs to be executed (baked) to generate the output (cupcakes) that the consumers enjoy.
</figcaption>
</figure>
</div>
<p>Like code, a recipe is just <strong>text that describes a sequence of steps to achieve a goal</strong>. What you ultimately want are delicious cupcakes (your result plots). The recipe (your script) details how to transform raw ingredients (input) into the baked goods (output). But the steps don‚Äôt mean anything unless you actually <strong>execute them</strong>‚Äîyou have to bake the cupcakes (run <code>python script.py</code>) to get results.</p>
<p>So, how can we write a good recipe?</p>
<section id="breaking-down-the-steps" class="level4">
<h4 class="anchored" data-anchor-id="breaking-down-the-steps">Breaking Down the Steps</h4>
<p>To start, we <strong>brainstorm all the necessary steps</strong> for making cupcakes (<a href="#fig-recipe-steps1" class="quarto-xref">Figure&nbsp;<span>4.7</span></a>). For this, we can again <strong>work backward from the final result</strong> (cupcakes) through the intermediate steps (cake batter and frosting) until we reach the raw ingredients.</p>
<div id="fig-recipe-steps1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-recipe-steps1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/recipe_steps1.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-recipe-steps1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.7: Everything you need to make cupcakes. The unstructured brain dump we‚Äôll transform into a proper recipe.
</figcaption>
</figure>
</div>
<p>You‚Äôll notice that your list includes both <strong>ingredients</strong> (in code: <strong>variables containing data</strong>) and <strong>instructions for transforming those ingredients</strong>, like melting butter or mixing multiple ingredients (in code: the <strong>control flow</strong>, i.e., statements, including conditionals (<code>if/else</code>) and loops (<code>for</code>, <code>while</code>), that create intermediate variables). These steps also need to follow a <strong>specific order</strong>‚Äîyou wouldn‚Äôt frost a cupcake before baking it! Often, steps <strong>depend on one another</strong>, requiring a structured sequence (<a href="#fig-recipe-steps2" class="quarto-xref">Figure&nbsp;<span>4.8</span></a>).</p>
<div id="fig-recipe-steps2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-recipe-steps2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/recipe_steps2.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-recipe-steps2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.8: A recipe usually includes a list of ingredients followed by instructions on what to do with them. The order matters, especially when one step depends on the completion of another.
</figcaption>
</figure>
</div>
</section>
<section id="avoiding-repetition-reusable-steps" class="level4">
<h4 class="anchored" data-anchor-id="avoiding-repetition-reusable-steps">Avoiding Repetition: Reusable Steps</h4>
<p>If your recipe is part of a cookbook with multiple related recipes, some steps might apply to several of them. Instead of repeating those steps in every recipe, you can <strong>group and document them in a separate section</strong> (in code: define a <strong>function</strong>) and reference them when needed (<a href="#fig-recipe-steps3" class="quarto-xref">Figure&nbsp;<span>4.9</span></a>).</p>
<p>This follows the <strong>Don‚Äôt Repeat Yourself (DRY)</strong> principle <span class="citation" data-cites="thomas2019pragmatic">[<a href="references.html#ref-thomas2019pragmatic" role="doc-biblioref">10</a>]</span>. Not only does this reduce redundancy, but it also makes updates easier‚Äîif a general step changes (e.g., you refine a technique or fix a typo), you only need to update it in one place (<strong>a single source of truth</strong>).</p>
<div id="fig-recipe-steps3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-recipe-steps3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/recipe_steps3.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-recipe-steps3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.9: Some instructions might be relevant in multiple recipes (e.g., general baking tips); instead of repeating them in every recipe, you can just refer to the page where they are described.
</figcaption>
</figure>
</div>
</section>
<section id="organizing-by-components" class="level4">
<h4 class="anchored" data-anchor-id="organizing-by-components">Organizing by Components</h4>
<p>Looking at your recipe, you might notice that some <strong>ingredients and instructions naturally group into self-contained components</strong> (in code: <strong>classes</strong>). Structuring the recipe this way makes it clearer and easier to follow (<a href="#fig-recipe-steps4" class="quarto-xref">Figure&nbsp;<span>4.10</span></a>). Instead of juggling all the steps at once, you can <strong>focus on creating one component at a time</strong>‚Äîfirst the plain cupcake, then the frosting, then assembling everything.</p>
<p>This modular approach also allows <strong>delegation</strong>‚Äîfor example, you could buy pre-made cupcakes and just focus on making the frosting. In programming, this means that <strong>the final code doesn‚Äôt need to know how each component was made‚Äîit only cares that the components exist</strong>.</p>
<div id="fig-recipe-steps4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-recipe-steps4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/recipe_steps4.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-recipe-steps4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.10: For more complex recipes where the final dish consists of multiple components (like cupcakes, which have a cake part and frosting), grouping by component improves clarity.
</figcaption>
</figure>
</div>
</section>
<section id="making-variants-with-minimal-effort" class="level4">
<h4 class="anchored" data-anchor-id="making-variants-with-minimal-effort">Making Variants with Minimal Effort</h4>
<p>Organizing a recipe into components also makes it easier to <strong>create variations</strong> (<a href="#fig-recipe-steps5" class="quarto-xref">Figure&nbsp;<span>4.11</span></a>).</p>
<p>Two key concepts make this possible:</p>
<ol type="1">
<li><strong>Polymorphism</strong>‚Äîeach variation should behave like the original so it can be used interchangeably (in code: implement the same <strong>interface</strong>).</li>
<li><strong>Code reuse</strong>‚Äîinstead of rewriting everything from scratch, <strong>extend</strong> the original recipe by specifying only the changes (in code: use <strong>inheritance</strong> or <strong>mixins</strong>).</li>
</ol>
<p>For example, a chocolate frosting variant extends the plain frosting recipe by adding cocoa powder. The rest of the instructions remain unchanged.</p>
<div id="fig-recipe-steps5" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-recipe-steps5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/recipe_steps5.png" class="img-fluid figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-recipe-steps5-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.11: Some components have variants that can be used as drop-in replacements. Since these variants extend the original (e.g., chocolate frosting builds on plain frosting), we reuse existing instructions and only describe what‚Äôs new.
</figcaption>
</figure>
</div>
<p>By applying these strategies, we turn a random assortment of ingredients and instructions into a well-structured, easy-to-follow recipe. This makes the cookbook not only clearer but the recipes also easier to maintain and extend‚Äîchanges to general instructions only need to be made once, and readers can effortlessly create variations by reusing existing steps.</p>
<p>Now, let‚Äôs take the same approach with code.</p>
</section>
</section>
<section id="encapsulated" class="level3">
<h3 class="anchored" data-anchor-id="encapsulated">Encapsulated</h3>
<p>Reading through a long script can be overwhelming. To make code easier to understand, we can <strong>group related lines into units such as functions and classes</strong>‚Äîa practice called <strong>encapsulation</strong>.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Encapsulation and cognitive load">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Encapsulation and cognitive load
</div>
</div>
<div class="callout-body-container callout-body">
<p>Once a block of code exceeds the limits of our working memory, it becomes hard to reason about. Splitting code into functions leverages the fact that <strong>our brains handle meaningful chunks far better than long sequences of individual elements</strong>. Remembering <code>177619181945196919892001</code> is difficult, but grouping the same digits into familiar chunks‚Äî1776, 1918, 1945, 1969, 1989, 2001‚Äîmakes it easy. Functions apply the same principle: they collapse many low-level details into a single, named concept. However, this only works if the chunks are meaningful; splitting code arbitrarily adds indirection and creates confusion.</p>
</div>
</div>
<p>As a first step, <strong>reorder the lines</strong> in your code so they <strong>follow overarching logical steps</strong>, such as <em>data preprocessing</em> or <em>model fitting</em>. For example, if you define a variable at the top of the script, then execute some unrelated computations, and only later use that variable, move the definition down so it‚Äôs closer to where it‚Äôs actually used. This alone already makes your script easier to follow because the reader doesn‚Äôt have to keep unrelated variables in mind while trying to understand what‚Äôs happening. You‚Äôll know you‚Äôve succeeded when your code is organized into separate blocks, each representing a distinct process step. You can even add a brief comment above each block describing, at a high level, what the following lines do.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Before:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> ...     <span class="co"># data</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ...  <span class="co"># model</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>df_processed <span class="op">=</span> ... <span class="co"># do something with df</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>model_fitted <span class="op">=</span> ... <span class="co"># do something with model</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># After:</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">### Step 1: data preprocessing</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> ...</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>df_processed <span class="op">=</span> ...</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">### Step 2: model fitting</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> ...</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>model_fitted <span class="op">=</span> ...</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The next step is to <strong>move these blocks into dedicated functions</strong> (e.g., <code>preprocessing</code>) <strong>or classes</strong> (e.g., <code>Model</code>). Done well, this makes your code even more readable: your main script is reduced to a few lines of calls to these units, while the individual functions and classes can be understood in isolation. At that point, you won‚Äôt even need the separating comments‚Äîyour structure will speak for itself.</p>
<p>In the following sections, we‚Äôll explore how to use encapsulation effectively to reduce complexity.</p>
<section id="from-complex-to-complicated" class="level4">
<h4 class="anchored" data-anchor-id="from-complex-to-complicated">From Complex to Complicated</h4>
<p>A well-known software engineering principle is <strong>KISS</strong>‚Äî‚ÄúKeep It Simple, Stupid!‚Äù While this is good advice at the level of individual functions or classes, it‚Äôs unrealistic to expect an entire software system to be <em>simple</em>. Most real-world software consists of multiple interacting components, making it inherently <em>complicated</em> rather than simple. The goal is to avoid unnecessary <strong>complexity</strong> (<a href="#fig-complexity" class="quarto-xref">Figure&nbsp;<span>4.12</span></a>).</p>
<div id="fig-complexity" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-complexity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/complexity.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-complexity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.12: In accordance with the <a href="https://en.wikipedia.org/wiki/Cynefin_framework">Cynefin framework</a>, (software) systems can have different levels of complexity <span class="citation" data-cites="khononov2024balancing">[<a href="references.html#ref-khononov2024balancing" role="doc-biblioref">2</a>]</span>. A script that sequentially executes a few steps might be simple. Most software, however, is at least complicated‚Äîit consists of multiple interacting components but can still be broken down into understandable subsystems. A complex system, often referred to as ‚Äúspaghetti code‚Äù or a ‚Äúbig ball of mud‚Äù <span class="citation" data-cites="foote1997big">[<a href="references.html#ref-foote1997big" role="doc-biblioref">1</a>]</span>, has so many interdependencies that its behavior is very difficult to predict‚Äîchanges in one part can have unintended consequences elsewhere.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> (Figure adapted from <span class="citation" data-cites="mcchrystal2015team">[<a href="references.html#ref-mcchrystal2015team" role="doc-biblioref">4</a>]</span>)
</figcaption>
</figure>
</div>
<p>A <strong>complex</strong> system has many interconnected elements with dependencies that are difficult to trace. Making a small change in one place can unexpectedly break something elsewhere. This makes debugging and maintenance a nightmare.</p>
<p>Instead, we aim for a <strong>complicated</strong> system‚Äîone that may have many components, but is structured into independent, well-organized subsystems <span class="citation" data-cites="khononov2024balancing">[<a href="references.html#ref-khononov2024balancing" role="doc-biblioref">2</a>]</span>. This way, we can understand and modify individual parts without having to fully grasp the entire system.</p>
<p>Decomposing a system this way will always constitute a trade-off, requiring us to balance <strong>local vs.&nbsp;global complexity</strong> <span class="citation" data-cites="khononov2024balancing">[<a href="references.html#ref-khononov2024balancing" role="doc-biblioref">2</a>]</span>. Consider two extremes:</p>
<ul>
<li>A system with <strong>two massive 500-line functions</strong> has low global complexity (only two things to keep track of) but high local complexity (each function is overwhelming to understand).</li>
<li>A system with <strong>500 tiny 2-line functions</strong> has low local complexity (each function is simple) but high global complexity (understanding how they interact becomes difficult).</li>
</ul>
<p>What constitutes a <strong>‚Äúright-sized‚Äù unit</strong>‚Äîsmall enough to be understandable, yet large enough to avoid excessive fragmentation‚Äîwill depend on the context and your personal preferences (I usually aim for around 5-15 lines of code, but more complicated algorithms may also justify longer functions).</p>
<div class="callout callout-style-default callout-note callout-titled" title="Cohesive units have a single responsibility">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Cohesive units have a single responsibility
</div>
</div>
<div class="callout-body-container callout-body">
<p>Following the <strong>single responsibility principle</strong>, each unit should be <strong>cohesive</strong>‚Äîfocused on a single, well-defined task, with all of its internal code serving that purpose.</p>
<p>For example, a cohesive function performs a single task. If a boolean flag in its arguments determines which code path it follows and leads to different return values, it‚Äôs better to split it into two separate functions.<br>
Similarly, a cohesive class is designed to represent one specific concept completely‚Äîand only that concept. If a class contains many attributes, and one group of methods uses one subset of those attributes while another group relies on a different, non-overlapping subset, this suggests the class no longer adheres to the single responsibility principle and should be broken into smaller, more focused classes.</p>
<p>However, the reverse is also true: units can be <strong>too narrowly defined to represent a complete task</strong>. For example, if three functions must always run in a specific order to produce a usable result, and none is ever called independently, they should likely be combined into a single function.</p>
</div>
</div>
</section>
<section id="interface-vs.-implementation" class="level4">
<h4 class="anchored" data-anchor-id="interface-vs.-implementation">Interface vs.&nbsp;Implementation</h4>
<p>The key idea of encapsulation is to establish a clear <strong>boundary</strong> between a unit‚Äôs internal logic and the rest of the program. This allows us to hide the complex <strong>implementation</strong> (the underlying code that users of the unit don‚Äôt need to see) behind a simple <strong>interface</strong> (the part exposed for use). This creates an effective <strong>abstraction</strong>, reducing cognitive load: users only need to understand how to interact with the unit, not how it works internally.</p>
<p>The <strong>interface</strong> serves as a contract, promising consistent behavior over time. The <strong>implementation</strong>, in contrast, is internal and can change freely‚Äîso others shouldn‚Äôt depend on it.</p>
<p>Let‚Äôs look at a simple example to see this in action:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_times_x(x, n):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        result <span class="op">+=</span> x</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># call our function with some values</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    my_result <span class="op">=</span> n_times_x(<span class="dv">3</span>, <span class="dv">5</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(my_result)  <span class="co"># should output 15</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The <strong>interface</strong> (also called signature) of the <code>n_times_x</code> function consists of:</p>
<ul>
<li>The function name (<code>n_times_x</code>)</li>
<li>The input arguments (<code>x</code> and <code>n</code>)</li>
<li>The return value (<code>result</code>)</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled" title="Make interfaces explicit">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Make interfaces explicit
</div>
</div>
<div class="callout-body-container callout-body">
<p>Interfaces should be <strong>explicit and foolproof</strong>, especially since not all users read documentation carefully.</p>
<p>For example, if a function relies on <strong>positional arguments</strong>, users might accidentally swap values, leading to hard-to-find bugs. Using <strong>keyword arguments</strong> (i.e., forcing users to specify argument names) makes the interface clearer and reduces errors.</p>
</div>
</div>
<p>As long as the interface remains unchanged, we can freely <strong>modify the implementation</strong>. For instance, we can replace the inefficient loop with a proper multiplication:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> n_times_x(x, n):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> n <span class="op">*</span> x</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This change improves efficiency, but since the function still works the same way externally (it‚Äôs called with the same arguments and returns the same results), <strong>no updates are required in other parts of the code</strong>. This is the power of clear boundaries.</p>
<p>However, changing a function‚Äôs <strong>name</strong>, for example, is another story. If we rename <code>n_times_x</code>, every reference to it must also be updated. Modern IDEs can automate this within a project, but if the function is used in external code (e.g., if it is part of an open source library), renaming requires a <strong>deprecation process</strong> to transition users gradually.</p>
<p>This is why <strong>choosing stable, well-thought-out interfaces upfront saves effort in the long run</strong>.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Go deep">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Go deep
</div>
</div>
<div class="callout-body-container callout-body">
<p>In accordance with the principle of <strong>information hiding</strong>, powerful units have <strong>narrow interfaces with deep implementations</strong>‚Äîthey expose only what‚Äôs necessary while handling meaningful computations internally <span class="citation" data-cites="ousterhout2018philosophy">[<a href="references.html#ref-ousterhout2018philosophy" role="doc-biblioref">6</a>]</span>. For example:</p>
<ul>
<li>A function might take just two inputs (narrow interface) but span ten lines of logic (deep implementation).</li>
<li>Or a one-liner function might implement a complex formula that users shouldn‚Äôt need to understand.</li>
</ul>
<p>But if your function is called <code>n_times_x</code>, and the implementation is just a one-liner doing exactly that, the abstraction does not help to reduce cognitive load. üòâ As a general rule, <strong>a unit‚Äôs interface should be significantly easier to understand than its implementation.</strong></p>
<p>Think of calling a function like <strong>handing off a task to a colleague</strong>: if it takes an hour to explain the relevant context (= many input arguments) so they can complete a task that would have taken you two minutes, the handoff isn‚Äôt effective. But if the task requires specialized expertise (= a complex implementation), you‚Äôre happy to delegate it to a properly trained colleague and just get the result back.</p>
</div>
</div>
<section id="class-interfaces" class="level5">
<h5 class="anchored" data-anchor-id="class-interfaces">Class Interfaces</h5>
<p><strong>A class groups attributes and methods that belong to a single entity.</strong> For well-structured classes, we should carefully control what is public and what is private:</p>
<ul>
<li><strong>Public attributes &amp; methods</strong> form the external interface‚Äîchanging them may break code elsewhere.</li>
<li><strong>Private attributes &amp; methods</strong> are meant for internal use and may be modified anytime.</li>
</ul>
<p>It is often useful to <strong>make attributes private</strong> and then <strong>control how they are accessed or updated through methods</strong>. This also implies that any external function that needs to modify an object‚Äôs attributes may be better implemented as a method within the corresponding class.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Public and private in different languages">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Public and private in different languages
</div>
</div>
<div class="callout-body-container callout-body">
<p>Access levels vary by programming language, for example:</p>
<ul>
<li><strong>Java</strong> has multiple levels (<code>public</code>, <code>protected</code>, <code>package</code>, <code>private</code>).</li>
<li><strong>Python</strong> relies on convention rather than enforcement. Prefixing names with <code>_</code> or <code>__</code> signals they are <em>‚Äúprivate‚Äù</em>, though they remain accessible.</li>
</ul>
<p>While Python won‚Äôt stop users from accessing private attributes, they do so <strong>at their own risk</strong>, knowing these details might change without notice.</p>
</div>
</div>
</section>
</section>
</section>
<section id="decoupled" class="level3">
<h3 class="anchored" data-anchor-id="decoupled">Decoupled</h3>
<blockquote class="blockquote">
<p><em>Two components are connascent [i.e., coupled] if a change in one would require the other to be modified in order to maintain the overall correctness of the system.</em><br>
‚Äì Meilir Page-Jones <span class="citation" data-cites="page1995every">[<a href="references.html#ref-page1995every" role="doc-biblioref">7</a>]</span></p>
</blockquote>
<p>We don‚Äôt want to just hide arbitrary implementation details behind an interface, but ideally these encapsulated units should also be <strong>decoupled</strong>. This means they should have as <strong>few dependencies as possible</strong> on other parts of the code or external resources, especially if these may change frequently. This makes the code easier to understand since <strong>each unit can be comprehended in isolation</strong>. But even more importantly, it <strong>simplifies modifications</strong>: when requirements change or new features are needed, we want to minimize the number of places that require updates. In contrast, <strong>if code is tightly coupled, a single change in one unit can ripple through multiple parts of the system</strong>, increasing the likelihood of errors.</p>
<section id="make-coupling-explicit" class="level4">
<h4 class="anchored" data-anchor-id="make-coupling-explicit">Make Coupling Explicit</h4>
<p>To build a larger software system that does something meaningful, we must compose it from multiple components. This inevitably means our units are coupled in some way‚Äîone function must call another, so they cannot exist in complete isolation. The goal is to <strong>make this coupling explicit so that if one unit changes, it is clear how dependent units need to be updated</strong>.</p>
<p>The most explicit form of coupling comes from referencing the <strong>public interface</strong> of a function or class. Any change in this interface should include a deprecation warning to support a smooth transition for the dependent units. The more explicit the public interface‚Äîsuch as using keyword arguments instead of positional ones‚Äîthe safer it is to depend on this unit, since compilers and static code analysis tools can detect changes or errors ahead of time, and IDEs can assist with refactoring.</p>
<p>Coupling becomes riskier when your code relies on a unit‚Äôs <strong>internal implementation details</strong>, like private attributes, undocumented quirks, or unintended behaviors (e.g., a function producing odd results when given inputs outside its intended range). Often, multiple parts of a program also share assumptions, such as the meaning of certain values (e.g., the magic number <code>404</code> representing the HTTP status code ‚Äúnot found‚Äù) or the use of a specific algorithm when encrypting and decrypting data.</p>
<p>The above examples are instances of static coupling, meaning they can be spotted in the source code directly. An even more error-prone form is <strong>dynamic coupling</strong>, visible only at runtime. For example, a class might require its methods to be called in a particular order to initialize all necessary values for a correct computation.</p>
<p>To minimize coupling risks, <strong>identify the assumptions your code makes</strong> about how and in which context it will be used. Don‚Äôt just document the correct usage and hope it‚Äôs followed, but make interactions explicit. This can mean defining formal interfaces, validating inputs, and enforcing usage constraints in code. Otherwise, the system becomes fragile, and even small changes in unrelated areas can cause breakages.</p>
</section>
<section id="levels-of-abstraction" class="level4">
<h4 class="anchored" data-anchor-id="levels-of-abstraction">Levels of Abstraction</h4>
<p>Ideally, our units should form a hierarchy with different <strong>levels of abstraction</strong> (<a href="#fig-abstraction-levels" class="quarto-xref">Figure&nbsp;<span>4.13</span></a>), where lower-level units can be used as building blocks to create more advanced functionality.</p>
<div id="fig-abstraction-levels" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-abstraction-levels-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/abstraction_levels.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-abstraction-levels-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.13: Complicated systems in software design often follow a hierarchy of abstraction. For example, to plot the results of a predictive model you call a function to create a scatter plot of predicted vs.&nbsp;actual values, which internally calls another, more specific function to compute the <span class="math inline">\(R^2\)</span> value displayed in the plot‚Äôs title.
</figcaption>
</figure>
</div>
<p>At each level, you only need to understand <strong>how to use</strong> the functions at lower levels but <strong>not their internals</strong>. This <strong>reduces cognitive load</strong>, making it easier to navigate and extend the codebase with confidence.</p>
<p>However, it‚Äôs important to note that <strong>low-level functions should ideally be kept stable</strong>, since everything built on top of them depends on their behavior. <strong>If the interface of such a function changes, any code that relies on it will also need to be updated</strong>. This applies not only to your own functions but also to external libraries your code depends on.</p>
<p>Standard libraries (i.e., those included with a programming language, not installed separately) are generally safe to build upon, as their functionality tends to be stable. In contrast, relying heavily on experimental or rapidly evolving libraries can lead to constant breakage as new versions introduce changes. To mitigate this, consider implementing an <strong>anti-corruption layer</strong>‚Äîa wrapper that provides a stable interface and handles necessary transformations when interacting with third-party code. This centralizes adaptation and isolates the rest of your code from volatile dependencies.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Avoid circular dependencies">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Avoid circular dependencies
</div>
</div>
<div class="callout-body-container callout-body">
<p>Maintaining a clear hierarchy of abstraction also helps prevent circular dependencies‚Äîsituations where two or more modules depend on each other, either directly or indirectly. Such dependencies break modular design: a change in one component can ripple unpredictably through others, making the system harder to reason about, test, and maintain. They also complicate initialization and reduce flexibility, since no component can evolve independently. Establishing <strong>clean dependency directions</strong>‚Äîwhere higher-level modules depend on lower-level ones, but not vice versa‚Äîkeeps the architecture stable and comprehensible.</p>
</div>
</div>
</section>
<section id="pure-vs.-impure-functions" class="level4">
<h4 class="anchored" data-anchor-id="pure-vs.-impure-functions">Pure vs.&nbsp;Impure Functions</h4>
<p>In addition to dependencies on code defined elsewhere, another form of coupling comes from <strong>relying on external resources</strong> (like files, databases, or APIs), which may also change frequently. These kinds of external dependencies are eliminated when our units are pure functions <span class="citation" data-cites="normand2021grokking">[<a href="references.html#ref-normand2021grokking" role="doc-biblioref">5</a>]</span>.</p>
<p>A <strong>pure function</strong> behaves like a mathematical function <span class="math inline">\(f: x \to y\)</span>, taking inputs <span class="math inline">\(x\)</span> and returning an output <span class="math inline">\(y\)</span>‚Äîand given the same inputs, the results will be the same every time. <strong>Impure functions</strong>, on the other hand, have side effects‚Äîthey interact with the outside world, such as reading from or writing to a file or modifying global state.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add(a, b):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pure: returns a computed result without side effects</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> write_file(file_path, result):</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># impure: writes data to a file (side effect)</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(file_path, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        f.write(result)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Why favor pure functions?</strong> First, they are <strong>predictable</strong>‚Äîcalling them with the same inputs always produces the same output, unlike impure functions, which may depend on changing external factors (e.g., the function may run fine the first time but then crash when trying to create a file that already exists or the computed results are suddenly different because in the meantime other code updated values stored in a database). Second, they are <strong>easy to test</strong> since they don‚Äôt rely on external state, as we‚Äôll show below.</p>
<p>That said, impure functions are often necessary‚Äîcode needs to have an effect on the outside world, otherwise why should we execute it in the first place? The trick is to <strong>encapsulate as much essential logic as possible in pure functions at the lower levels of abstraction, while isolating side effects in higher levels</strong>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pure_function(data):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># process data (pure logic)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> ...</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> impure_function():</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"some_input.txt"</span>) <span class="im">as</span> f:</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> f.read()</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pure_function(data)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"some_output.txt"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        f.write(result)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This structure ensures the core logic is <strong>pure and testable</strong>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tests.py</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_pure_function():</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> <span class="st">"some test data"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> pure_function(data)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> result <span class="op">==</span> <span class="st">"some test result"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="dependency-injection-for-flexibility" class="level5">
<h5 class="anchored" data-anchor-id="dependency-injection-for-flexibility">Dependency Injection for Flexibility</h5>
<p>To further decouple your code, use <strong>dependency injection</strong> <span class="citation" data-cites="percival2020architecture">[<a href="references.html#ref-percival2020architecture" role="doc-biblioref">8</a>]</span>: instead of hardcoding dependencies (e.g., file operations, database access), pass them as arguments. This allows functions to remain independent of specific implementations.</p>
<p>Without dependency injection:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataSource:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read(<span class="va">self</span>):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"some_input.txt"</span>) <span class="im">as</span> f:</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> f.read()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write(<span class="va">self</span>, result):</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"some_output.txt"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>            f.write(result)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun_without_di():</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create external dependency inside the function</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> DataSource()</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> ds.read()</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> ...</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    ds.write(result)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>With dependency injection:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fun_with_di(ds):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dependency is passed as an argument</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> ds.read()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> ...</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    ds.write(result)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    ds <span class="op">=</span> DataSource()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    fun_with_di(ds)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now, <code>fun_with_di</code> only requires an object implementing <code>read</code> and <code>write</code>, but it <strong>doesn‚Äôt care</strong> if it‚Äôs a <code>DataSource</code> or something else that implements the same interface. This makes testing much easier:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tests.py</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MockDataSource:</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read(<span class="va">self</span>):</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"Mocked test data"</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> write(<span class="va">self</span>, result):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_fun_with_di():</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    mock_ds <span class="op">=</span> MockDataSource()</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    fun_with_di(mock_ds)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> mock_ds.success</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Dependency injection can also be <strong>combined with pure functions</strong> to make your code testable at different levels of abstraction (<a href="#fig-dependency-injection" class="quarto-xref">Figure&nbsp;<span>4.14</span></a>).</p>
<div id="fig-dependency-injection" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dependency-injection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/03_code/dependency_injection.png" class="img-fluid figure-img" style="width:75.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dependency-injection-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.14: The main function (<code>do_something</code>) can be invoked through multiple entry points, such as a CLI script, a web API endpoint, or test code. Each entry point constructs a <code>data_source</code> object‚Äîeither a <code>RealDataSource</code> with database access or, in tests, a <code>MockDataSource</code>‚Äîwhich is then passed to <code>do_something</code>, where <code>data_source.read</code> is called. But <code>do_something</code> does not directly depend on <code>RealDataSource</code> or <code>MockDataSource</code>.
</figcaption>
</figure>
</div>
<p>This approach also makes it straightforward to <strong>extend your code</strong> by integrating additional data sources through wrappers that share the same interface. For example, if you switch to a different type of database, you only need to implement a new wrapper class and initialize it in the outer calling code; the main function and its dependencies can remain unchanged.</p>
<p>A key point here is to design your code for <strong>testability</strong> by abstracting access to external resources that should not be touched during tests. While it often makes sense to introduce dedicated wrappers for complex data sources such as databases, simpler cases do not always require this level of abstraction. If your function only reads from a CSV file, it may be sufficient to pass the file path as an argument and use a separate, smaller test file when running tests.</p>
</section>
<section id="anti-pattern-global-variables" class="level5">
<h5 class="anchored" data-anchor-id="anti-pattern-global-variables">Anti-Pattern: Global Variables</h5>
<p>Besides external resources like files and databases, another source of <strong>tight coupling and error-prone behavior</strong> is relying on <strong>global variables</strong>. These are defined at the script level (often below import statements) and can be accessed or modified anywhere in the code.</p>
<p>Global variables can introduce <strong>temporal coupling</strong>, meaning the order of function execution suddenly matters. This can lead to subtle and hard-to-debug issues:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>PI <span class="op">=</span> <span class="fl">3.14159</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_area_impure(r):</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># since PI is not defined inside the function,</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the fallback is to use the global variable</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> PI <span class="op">*</span> r<span class="op">**</span><span class="dv">2</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> change_pi(new_pi<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `global` is needed to not create a new local variable</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> PI</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    PI <span class="op">=</span> new_pi</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    area_org <span class="op">=</span> calc_area_impure(r)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    change_pi()</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    area_new <span class="op">=</span> calc_area_impure(r)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> area_org <span class="op">==</span> area_new, <span class="st">"Unexpectedly different results!"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The safer approach is to pass values explicitly:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_area_pure(r, pi):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pi <span class="op">*</span> r<span class="op">**</span><span class="dv">2</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This avoids hidden dependencies and ensures reproducibility.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>To prevent unintended global variables, <strong>wrap your script logic inside a function</strong>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>   <span class="co"># main script code incl. variable definitions</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>   ...</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This ensures that variables defined inside <code>main()</code> don‚Äôt leak into the global namespace.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Think you need global variables? Wrap your code inside a class instead!">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Think you need global variables? Wrap your code inside a class instead!
</div>
</div>
<div class="callout-body-container callout-body">
<p>If multiple functions need to update the same set of variables, consider <strong>grouping them into a class</strong> instead of passing the same arguments repeatedly or relying on globals. A class can store shared state in attributes, accessed via <code>self</code>.</p>
</div>
</div>
</section>
<section id="call-by-value-vs.-call-by-reference" class="level5">
<h5 class="anchored" data-anchor-id="call-by-value-vs.-call-by-reference">üö® Call-By-Value vs.&nbsp;Call-By-Reference</h5>
<p>Another common pitfall is <strong>accidentally modifying function arguments</strong>.</p>
<p>Depending on the programming language you use, input arguments are passed:</p>
<ul>
<li><strong>By value</strong>: A copy of the data is passed.</li>
<li><strong>By reference</strong>: The function gets access to the original memory location and can modify the data directly.</li>
</ul>
<p>Python uses <strong>call-by-reference for mutable objects</strong> (e.g., lists, dictionaries), which can lead to unexpected behavior:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> change_list(a_list):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    a_list[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">42</span>  <span class="co"># modifies the original list</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a_list</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    my_list <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(my_list)  <span class="co"># [1, 2, 3]</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    new_list <span class="op">=</span> change_list(my_list)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(new_list) <span class="co"># [42, 2, 3]</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(my_list)  <span class="co"># [42, 2, 3] üò±</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>To prevent such side effects, create a copy of the variable before modifying it. This ensures the original remains unchanged:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copy <span class="im">import</span> deepcopy</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> change_list(a_list):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    a_list <span class="op">=</span> deepcopy(a_list)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    a_list[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a_list</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    my_list <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>]</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    new_list <span class="op">=</span> change_list(my_list)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(my_list)  <span class="co"># [1, 2, 3] üòä</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>To avoid sneaky bugs, <strong>test your code to verify</strong>:</p>
<ol type="1">
<li><strong>Inputs remain unchanged</strong> after execution.</li>
<li>The function <strong>produces the same output when called twice</strong> with identical inputs.</li>
</ol>
</section>
</section>
<section id="dont-repeat-yourself-dry" class="level4">
<h4 class="anchored" data-anchor-id="dont-repeat-yourself-dry">Don‚Äôt Repeat Yourself (DRY)</h4>
<p>A more subtle form of coupling comes from violating the <strong>DRY (Don‚Äôt Repeat Yourself) principle</strong>. For example, critical business logic‚Äîsuch as computing an evaluation metric, applying a discount in an e-commerce system, or validating data, like the rules that define an acceptable password‚Äîmight be duplicated across several locations. If this logic needs to change (due to an error or evolving business requirements), you‚Äôd need to update multiple places, making your code harder to maintain and more prone to bugs. To avoid inconsistencies and duplicated work, make sure that important values and business rules are defined in a central place, the <strong>single source of truth</strong>.</p>
<p>The most obvious DRY violation occurs when you catch yourself <strong>copy-pasting code</strong>‚Äîthis is a clear signal to refactor it into a reusable function. However, DRY isn‚Äôt just about code; it applies to <strong>anything where a single change in requirements forces multiple updates</strong>, including tests, documentation, or data stored across different databases <span class="citation" data-cites="thomas2019pragmatic">[<a href="references.html#ref-thomas2019pragmatic" role="doc-biblioref">10</a>]</span>. To maintain your code effectively, aim to make each change in one place only. If that‚Äôs not feasible, at least keep related elements close together‚Äîfor example, documenting interfaces using docstrings in the code rather than in separate files.</p>
</section>
</section>
<section id="reusable" class="level3">
<h3 class="anchored" data-anchor-id="reusable">Reusable</h3>
<p>While we want to keep interfaces narrow and simple, we also want our units to be broadly applicable. This often means <strong>replacing hardcoded values with function arguments</strong>. Consider these two functions:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> a_plus_1(a):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> a_plus_b(a, b<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The first function is highly specific, while the second is more general and adaptable. By providing <strong>sensible default values</strong> (<code>b=1</code>), we keep the function easy to use while allowing flexibility for more advanced cases.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Reusable code through refactoring, not overengineering">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Reusable code through refactoring, not overengineering
</div>
</div>
<div class="callout-body-container callout-body">
<p>Reusable code isn‚Äôt typically created on the first try because future needs are unpredictable. Instead of overengineering, focus on writing simple, clear code and adapt it as new opportunities for reuse emerge. This process, called <em>refactoring</em>, is covered in more detail in <a href="04_implementation.html#sec-refactoring" class="quarto-xref"><span>Section 5.7</span></a>.</p>
</div>
</div>
<p>That said, if your function ends up with ten arguments, reconsider whether it really has a <strong>single responsibility</strong>. If it‚Äôs doing too much, breaking it into multiple functions is likely a better approach.</p>
<section id="polymorphism" class="level5">
<h5 class="anchored" data-anchor-id="polymorphism">Polymorphism</h5>
<p>When working with classes, reuse can be achieved through <strong>polymorphism</strong>, where multiple classes implement the same interface and can be used interchangeably. We‚Äôve already applied this principle when we used <code>MockDataSource</code> instead of <code>DataSource</code> for testing. This approach can be useful in research code as well, for example, you could define a <code>Model</code> interface with <code>fit</code> and <code>predict</code> methods so multiple models can share the same experiment logic:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, x, y):</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyModel(Model):</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, x, y):</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        ...  <span class="co"># implementation</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x):</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> ...</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> y_pred</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_experiment(model: Model):</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this code works with any model that implements</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># appropriate fit and predict functions</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    x_train, y_train <span class="op">=</span> ...</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    model.fit(x_train, y_train)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    x_test <span class="op">=</span> ...</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    y_test_pred <span class="op">=</span> model.predict(x_test)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># create a specific model (possibly based on arguments</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># passed by the user when calling the script)</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> MyModel()</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    run_experiment(model)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This way you can reuse your analysis code with all your models, which not only avoids redundancy, but ensures that all models are evaluated consistently.</p>
</section>
<section id="mixins" class="level5">
<h5 class="anchored" data-anchor-id="mixins">Mixins</h5>
<p>Another approach to reuse is using <strong>mixins</strong>‚Äîsmall reusable classes that provide additional functionality:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ScoredModelMixin:</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score(<span class="va">self</span>, x, y):</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> <span class="va">self</span>.predict(x)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.mean((y <span class="op">-</span> y_pred)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyModel(Model, ScoredModelMixin):</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    ...</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> MyModel()</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this uses the function implemented in ScoredModelMixin</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(model.score(np.random.randn(<span class="dv">5</span>, <span class="dv">3</span>), np.random.randn(<span class="dv">5</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Historically, deep class hierarchies with multiple levels of inheritance were common, but they often led to unnecessary complexity. Instead of forcing all functionality into a single class hierarchy, it‚Äôs better to keep interfaces narrow and <strong>compose functionality from multiple small, focused classes</strong>.</p>
</section>
<section id="breaking-code-into-modules" class="level4">
<h4 class="anchored" data-anchor-id="breaking-code-into-modules">Breaking Code into Modules</h4>
<p>Starting a new project often begins with all your code in a single script. This is fine for quick and small tasks, but as your project grows, keeping everything in one file becomes messy and overwhelming. To keep your code organized and easier to understand, it‚Äôs a good idea to move functionality into separate files, also referred to as (sub)modules. Separating code into modules makes your project easier to navigate and can lay the foundation for your own <strong>library of reusable functions and classes</strong>, useful across multiple projects.</p>
<p>A typical first step is splitting the main logic of your analysis (<code>main.py</code>) from general-purpose helper functions (<code>utils.py</code>). Over time, as <code>utils.py</code> expands, you‚Äôll notice clusters of related functionality that can be moved into their own files, such as <code>data_utils.py</code>, <code>models.py</code>, or <code>results.py</code>. To create cohesive modules, you should <strong>group code that tends to change together</strong>, which increases maintainability as you don‚Äôt need to switch between files when implementing a new feature. Modules based on domains or use cases, instead of technical layers, are therefore preferred, as the changes required to implement a new feature are generally limited to a single domain <span class="citation" data-cites="lilienthal2023ddt">[<a href="references.html#ref-lilienthal2023ddt" role="doc-biblioref">3</a>]</span>.</p>
<p>This approach naturally leads to a clean directory structure, which might look like this for a larger Python project:<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">src/</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">‚îú‚îÄ‚îÄ</span> main.py</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="ex">‚îî‚îÄ‚îÄ</span> my_library/</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îú‚îÄ‚îÄ</span> __init__.py</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îú‚îÄ‚îÄ</span> data_utils.py</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îú‚îÄ‚îÄ</span> models/</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îÇ</span>   ‚îú‚îÄ‚îÄ __init__.py</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îÇ</span>   ‚îú‚îÄ‚îÄ baseline_a.py</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îÇ</span>   ‚îú‚îÄ‚îÄ baseline_b.py</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îÇ</span>   ‚îú‚îÄ‚îÄ interface.py</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îÇ</span>   ‚îî‚îÄ‚îÄ my_model.py</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">‚îî‚îÄ‚îÄ</span> results.py</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In <code>main.py</code>, you can import the relevant classes and functions from these modules to keep the main script clean and focused:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> my_library.models.my_model <span class="im">import</span> MyModel</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> my_library.data_utils <span class="im">import</span> load_data</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># steps that will be executed when running `python main.py`</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> MyModel()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-tip callout-titled" title="Keep helper functions separate">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Keep helper functions separate
</div>
</div>
<div class="callout-body-container callout-body">
<p>Always <strong>separate reusable helper functions from the main executable code</strong>. This also means that files like <code>data_utils.py</code> should not include a <em>main</em> function, as they are not standalone scripts. Instead, these modules provide functionality that can be imported by other scripts‚Äîjust like external libraries such as <code>numpy</code>.</p>
</div>
</div>
<p>As you tackle more projects, you may develop a set of functions that are so versatile and useful that you find yourself reusing them across multiple projects. At that point, you might consider packaging them as your own <strong>open-source library</strong>, allowing other researchers to install and use them as well.</p>
</section>
</section>
<section id="summary-from-working-to-good-code" class="level3">
<h3 class="anchored" data-anchor-id="summary-from-working-to-good-code">Summary: From Working to Good Code</h3>
<p>With these best practices in mind, revisit the steps you outlined when working backward from your desired output (in our case a plot) to the necessary inputs (data) and transform your <em>working code</em> into <em>good code</em>:</p>
<ol type="1">
<li><strong>Group related steps into reusable functions.</strong> Functions like <code>load_data</code>, <code>fit_model</code>, <code>predict_with_model</code>, and <code>compute_r2</code> help structure your code and prevent redundancy (DRY principle).</li>
<li><strong>Identify explicit and implicit inputs and outputs:</strong>
<ul>
<li><strong>Inputs</strong>: Passed as function arguments or read from external sources (files, databases, APIs).</li>
<li><strong>Outputs</strong>: Return values or data written to an external source (but avoid other side effects, like modifying input arguments or global variables).</li>
</ul></li>
<li><strong>Extract pure functions</strong>, which use only explicit inputs (arguments) and outputs (return values), from functions that rely on external resources or have other side effects. For example, if <code>load_data</code> includes both file I/O and preprocessing, separate out <code>preprocess</code> as a pure function to improve testability. Additionally, consider opportunities for <strong>dependency injection</strong>.</li>
<li><strong>Encapsulate related variables and functions into classes</strong>:
<ul>
<li>Look for <strong>multiple variables describing the same object</strong> (e.g., parameters describing a <code>Model</code> instance).</li>
<li>Identify <strong>functions that need access to private attributes</strong> or should update attributes in-place (e.g., <code>fit</code> and <code>predict</code> should be methods of <code>Model</code>).</li>
</ul></li>
<li><strong>Generalize where possible</strong>:
<ul>
<li>Should <strong>hardcoded values</strong> be passed as function arguments?</li>
<li>Could multiple classes implement a <strong>unified interface</strong>? For example, different model classes should all implement the same <code>fit</code> and <code>predict</code> methods so they can be used with the same analysis code. They might also share some functionality through <strong>mixins</strong>.</li>
</ul></li>
<li><strong>Organize your code into modules</strong> (i.e., separate files and folders) when it grows too large:
<ul>
<li>Keep closely related functions together (e.g., <code>load_data</code> and <code>preprocess</code>, which can be expected to change together).</li>
<li>Place logically grouped files into separate directories (e.g., <code>models/</code> for different model implementations).</li>
</ul></li>
</ol>
<p>By following these steps, you‚Äôll create code that is not only functional but also maintainable and extensible. However, <strong>avoid overengineering</strong> by trying to predict every possible future requirement. Instead, keep your code <strong>as simple as possible</strong> and refactor it <strong>as actual needs evolve</strong>.</p>
</section>
</section>
<section id="sec-draw-code" class="level2">
<h2 class="anchored" data-anchor-id="sec-draw-code">Draw Your Code</h2>
<p>To summarize the overall design, we can create sketches that serve as both a high-level overview and an implementation guide. While formal modeling languages like UML exist for this purpose, don‚Äôt feel pressured to use them‚Äîthese diagrams are for you and your collaborators, so <strong>prioritize clarity over formality</strong>. Unless they‚Äôre part of official documentation that must meet specific standards, a quick whiteboard sketch is often a better use of your time.</p>
<p>We distinguish between two types of diagrams:</p>
<ol type="1">
<li><strong>Structural diagrams</strong> ‚Äì These show the organization of your code: which functions and classes are in which modules, and how they depend on one another.</li>
<li><strong>Behavioral diagrams</strong> ‚Äì These describe how your program runs: how inputs flow through the system and are transformed into outputs.</li>
</ol>
<section id="structure-your-personal-code-library" class="level4">
<h4 class="anchored" data-anchor-id="structure-your-personal-code-library">Structure: Your Personal Code Library</h4>
<p>Our first sketch provides an overview of the <strong>reusable functions and classes</strong> we assembled in the previous section (<a href="#fig-draw-library" class="quarto-xref">Figure&nbsp;<span>4.15</span></a>). This collection forms your <strong>personal code library</strong>, which you can reuse not just for this project but for future ones as well.</p>
<div id="fig-draw-library" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-draw-library-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/00_clarity/draw_library.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-draw-library-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.15: The different functions and classes in our personal library, a collection of reusable units that can serve us in multiple projects. They are organized in different files and folders to keep related code close together. Green boxes represent pure functions, purple boxes impure functions with side effects (like reading or writing to external files), and blue boxes class methods. For classes (like <code>MyModel</code>) that extend another class (<code>Model</code>), only the additional attributes and methods are listed for that class. The arrows indicate dependencies.
</figcaption>
</figure>
</div>
</section>
<section id="behavior-mapping-out-your-script" class="level4">
<h4 class="anchored" data-anchor-id="behavior-mapping-out-your-script">Behavior: Mapping Out Your Script</h4>
<p>Our second sketch outlines the <strong>script you‚Äôll execute</strong> to create the results you want, which builds upon the components from your personal library (<a href="#fig-draw-script" class="quarto-xref">Figure&nbsp;<span>4.16</span></a>). When designing the flow of your script, consider:</p>
<ul>
<li><strong>How the script is triggered</strong> ‚Äì Does it take command-line arguments? What inputs does it require?</li>
<li><strong>What the final output should be</strong> ‚Äì A results plot? A summary table? Something else?</li>
<li><strong>Which intermediate results should be saved</strong> ‚Äì If your script crashes, you don‚Äôt want to start over. Since variables in memory disappear when the script terminates, consider saving key outputs to disk at logical checkpoints.</li>
<li><strong>Which functions and classes from your library are used at each step</strong> ‚Äì Also, note any external resources (e.g., files, databases, or APIs) the code interacts with.</li>
</ul>
<div id="fig-draw-script" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-draw-script-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="../images/00_clarity/draw_script.png" class="img-fluid figure-img" style="width:100.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-draw-script-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.16: The full flow of your script, including external resources and reusable functions. If you want, you can omit the lower level function calls as these are already covered in the library diagram. The code to create a new model should create models of different types depending on the configuration parameters passed when calling the script so you can use the same script for multiple experiments.
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-caution callout-titled" title="Before you continue">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Caution</span>Before you continue
</div>
</div>
<div class="callout-body-container callout-body">
<p>At this point, you should have a clear understanding of:</p>
<ul>
<li>The inputs and transformations required to produce your desired outputs‚Äîwhat constitutes <em>working code</em>.</li>
<li>How to structure this code into <em>good code</em> by creating cohesive, decoupled, and reusable units that use simple interfaces to abstract away complicated implementation details.</li>
</ul>
</div>
</div>


<div id="refs" class="references csl-bib-body" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-foote1997big" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">Foote B, Yoder J. Big Ball of Mud. <em>Pattern languages of program design</em> 4, 654‚Äì692 (1997).</div>
</div>
<div id="ref-khononov2024balancing" class="csl-entry" role="listitem">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">Khononov V. <em>Balancing Coupling in Software Design: Universal Design Principles for Architecting Modular Software Systems</em>. Addison-Wesley Professional (2024).</div>
</div>
<div id="ref-lilienthal2023ddt" class="csl-entry" role="listitem">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">Lilienthal C, Schwentner H. <em>Domain-Driven Transformation: Monolithen Und Microservices Zukunftsf√§hig Machen</em>. dpunkt.verlag (2023).</div>
</div>
<div id="ref-mcchrystal2015team" class="csl-entry" role="listitem">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">McChrystal GS, Collins T, Silverman D, Fussell C. <em>Team of Teams: New Rules of Engagement for a Complex World</em>. Penguin (2015).</div>
</div>
<div id="ref-normand2021grokking" class="csl-entry" role="listitem">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">Normand E. <em>Grokking Simplicity: Taming Complex Software with Functional Thinking</em>. Manning Publications (2021).</div>
</div>
<div id="ref-ousterhout2018philosophy" class="csl-entry" role="listitem">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline">Ousterhout JK. <em>A Philosophy of Software Design</em>. Yaknyam Press Palo Alto, CA, USA (2018).</div>
</div>
<div id="ref-page1995every" class="csl-entry" role="listitem">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline">Page-Jones M. <em>What Every Programmer Should Know about Object-Oriented Design</em>. Dorset House (1995).</div>
</div>
<div id="ref-percival2020architecture" class="csl-entry" role="listitem">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline">Percival H, Gregory B. <em>Architecture Patterns with Python: Enabling Test-Driven Development, Domain-Driven Design, and Event-Driven Microservices</em>. O‚ÄôReilly Media, Inc. (2020).</div>
</div>
<div id="ref-skiena2008algorithm" class="csl-entry" role="listitem">
<div class="csl-left-margin">[9] </div><div class="csl-right-inline">Skiena SS. <em>The Algorithm Design Manual</em>. Springer (2020).</div>
</div>
<div id="ref-thomas2019pragmatic" class="csl-entry" role="listitem">
<div class="csl-left-margin">[10] </div><div class="csl-right-inline">Thomas D, Hunt A. <em>The Pragmatic Programmer: Your Journey to Mastery, 20th Anniversary Edition</em>. Addison-Wesley Professional (2019).</div>
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>The fourth Cynefin category is <strong>chaotic</strong>, where cause and effect are unknowable. In software, this could be compared to rare cosmic-ray-induced bit flips that cause random, unpredictable behavior.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn2"><p>In some programming languages, you can define <strong>constants</strong>‚Äîvariables whose values cannot be changed. These are often declared as global variables so that all other code can reference the same value. In Python, constants are defined by convention using <code>ALL_CAPS</code> variable names. However, Python does not enforce immutability, so the value can still be changed despite the naming convention.<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
<li id="fn3"><p>The <code>__init__.py</code> file is needed to turn a directory into a package from which other scripts can import functionality. Usually, the file is completely empty.<a href="#fnref3" class="footnote-back" role="doc-backlink">‚Ü©Ô∏é</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script type="text/javascript"> // go once over all images and transform the percentage width into pixels relative to original body size
  const bodyWidth = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--custom-body-width')); // Get CSS variable
  document.querySelectorAll('.quarto-figure img').forEach((img) => {
    if (img.getAttribute('style')) {
      const styleWidth = img.getAttribute('style').match(/width:\s*([\d.]+)%/); // Extract percentage
      if (styleWidth) {
        let percentage = parseFloat(styleWidth[1]) / 100;
        if (percentage < 1) {
          percentage *= 0.87  // had to increase image width for pdf
        }
        img.style.width = `${bodyWidth * percentage}px`; // Apply calculated width
      }
    }
  });
</script>

<style type="text/css">
#footer {
  font-size: 80%; /* Makes the font 70% smaller */
  border-top: 1px solid #ccc; /* Adds a horizontal line above the footer */
  padding-top: 10px; /* Adds some spacing above the footer content */
}
</style>

<!-- FOOTER  -->
<div id="footer" class="outer">
  <footer class="inner">

    <p>Buy the PDF and EPUB editions of this book on <a href="https://leanpub.com/cddsci" target="_blank" rel="nofollow">Leanpub</a>.</p>

    <p>Find me on <a href="https://github.com/cod3licious/" target="_blank" rel="nofollow">GitHub</a> and <a href="https://www.linkedin.com/in/franziska-horn/" target="_blank" rel="nofollow">LinkedIn</a><br>
      <a href="https://franziskahorn.de/">Home</a> ~ <a href="mailto:hey@franziskahorn.de?Subject=Book%20Feedback" target="_blank" rel="nofollow">Contact</a> ~ <a href="https://franziskahorn.de/impressum.html">Impressum</a></p>

      <!-- CC license -->
    <p xmlns:cc="http://creativecommons.org/ns#">This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-NC-ND 4.0<img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1" alt=""><img style="height:16px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/nd.svg?ref=chooser-v1" alt=""></a></p>
  </footer>
</div>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02_output_what.html" class="pagination-link" aria-label="Output: What?">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Output: What?</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./part2.html" class="pagination-link" aria-label="Part 2: Writing Code">
        <span class="nav-page-text">Part 2: Writing Code</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>